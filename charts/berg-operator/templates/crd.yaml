apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: challengeinstances.berg.norelect.ch
  labels:
    {{- include "berg-operator.labels" . | nindent 4 }}
spec:
  group: berg.norelect.ch
  names:
    kind: ChallengeInstance
    listKind: ChallengeInstanceList
    plural: challengeinstances
    singular: challengeinstance
    shortNames:
    - ci
    - instance
  scope: Namespaced
  versions:
  - name: v1
    served: true
    storage: true
    schema:
      openAPIV3Schema:
        type: object
        required:
        - spec
        properties:
          spec:
            type: object
            required:
            - challengeRef
            - ownerId
            - flag
            properties:
              challengeRef:
                type: object
                required:
                - name
                properties:
                  name:
                    type: string
                  namespace:
                    type: string
              ownerId:
                type: string
                pattern: '^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$'
              flag:
                type: string
                maxLength: 1024
              timeout:
                type: string
                pattern: '^([0-9]+h)?([0-9]+m)?([0-9]+s)?$'
                default: "2h"
              terminationReason:
                type: string
                enum:
                - UserRequest
                - Timeout
                - AdminTermination
          status:
            type: object
            properties:
              instanceId:
                type: string
              phase:
                type: string
                enum:
                - Pending
                - Creating
                - Starting
                - Running
                - Terminating
                - Terminated
                - Failed
              namespace:
                type: string
              services:
                type: array
                items:
                  type: object
                  required:
                  - name
                  - hostname
                  - port
                  - protocol
                  properties:
                    name:
                      type: string
                    hostname:
                      type: string
                    port:
                      type: integer
                      minimum: 1
                      maximum: 65535
                    protocol:
                      type: string
                    appProtocol:
                      type: string
                    tls:
                      type: boolean
              startedAt:
                type: string
                format: date-time
              readyAt:
                type: string
                format: date-time
              terminatedAt:
                type: string
                format: date-time
              expiresAt:
                type: string
                format: date-time
              conditions:
                type: array
                items:
                  type: object
                  required:
                  - type
                  - status
                  properties:
                    type:
                      type: string
                    status:
                      type: string
                      enum:
                      - "True"
                      - "False"
                      - Unknown
                    lastTransitionTime:
                      type: string
                      format: date-time
                    reason:
                      type: string
                    message:
                      type: string
              observedGeneration:
                type: integer
    subresources:
      status: {}
    additionalPrinterColumns:
    - name: Challenge
      type: string
      jsonPath: .spec.challengeRef.name
    - name: Owner
      type: string
      jsonPath: .spec.ownerId
    - name: Phase
      type: string
      jsonPath: .status.phase
    - name: Namespace
      type: string
      jsonPath: .status.namespace
    - name: Age
      type: date
      jsonPath: .metadata.creationTimestamp
    - name: Expires
      type: date
      jsonPath: .status.expiresAt
